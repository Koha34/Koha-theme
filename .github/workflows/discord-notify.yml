name: Discord Notify               # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åï¼ˆActions ã‚¿ãƒ–ã«è¡¨ç¤ºï¼‰

# ===== ãƒˆãƒªã‚¬ãƒ¼ =====
on:
  push:                            # Push ã‚¤ãƒ™ãƒ³ãƒˆ
    branches: [ main ]             #   â†’ main ãƒ–ãƒ©ãƒ³ãƒã ã‘å¯¾è±¡
  pull_request:                    # PR ã‚¤ãƒ™ãƒ³ãƒˆ
    types: [ opened, closed ]      #   â†’ ä½œæˆã¨ãƒžãƒ¼ã‚¸æ™‚
  release:                         # Release ã‚¤ãƒ™ãƒ³ãƒˆ
    types: [ published ]           #   â†’ æ–°è¦ãƒªãƒªãƒ¼ã‚¹æ™‚

# ===== ã‚¸ãƒ§ãƒ–å®šç¾© =====
jobs:
  notify:
    runs-on: ubuntu-latest  

    steps:
    # å¿…è¦ãªã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (diff ç”¨)
    - name: Checkout
      uses: actions/checkout@v4

    - name: Assemble Discord Message
      id: build
      run: |
        # ------ ã‚¤ãƒ™ãƒ³ãƒˆã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ„ã¿ç«‹ã¦ ------
        if [[ "${{ github.event_name }}" == "push" ]]; then
          EVENT="ðŸ”„ **Push** to \`${{ github.ref_name }}\`"
          URL="${{ github.event.compare }}"
          COLOR="3447003"
          DESCRIPTION="$(git log -1 --pretty=format:'%s (%an)')"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            EVENT="âœ… **PR Merged** #${{ github.event.pull_request.number }}"
            COLOR="5763719"
          else
            EVENT="ðŸ“£ **PR Opened** #${{ github.event.pull_request.number }}"
            COLOR="16753920"
          fi
          URL="${{ github.event.pull_request.html_url }}"
          DESCRIPTION="${{ github.event.pull_request.title }}"
        else
          EVENT="ðŸ·ï¸ **Release** \`${{ github.event.release.tag_name }}\`"
          URL="${{ github.event.release.html_url }}"
          COLOR="15844367"
          DESCRIPTION="${{ github.event.release.name }}"
        fi

        jq -n --arg title "$EVENT" \
              --arg url "$URL" \
              --arg desc "$DESCRIPTION" \
              --arg color "$COLOR" \
        '{embeds:[{title:$title,url:$url,description:$desc,color:($color|tonumber)}]}' > discordmsg.json

    - name: Post to Discord Webhook
      uses: fjogeleit/http-request-action@v1     
      with:
        url: ${{ secrets.DISCORD_WEBHOOK_URL }} 
        method: 'POST'
        contentType: 'application/json'
        dataFile: 'discordmsg.json'

